version: "3.8"
services:
  node:
    build: "."
    image: sv-mosaic:local
    volumes:
      - "./src:/app/src"
      - "./testing:/app/testing"
      - "./.storybook:/app/.storybook"
      - "./scripts:/app/scripts"
      - "./dist:/app/dist"
      - "./package.json:/app/mounted/package.json"
      - "./yarn.lock:/app/mounted/yarn.lock"
      - "./.yarn:/app/mounted/.yarn"
      - "./webpack.config.js:/app/webpack.config.js"
      - "./.babelrc:/app/.babelrc"
      - "./tsconfig.json:/app/tsconfig.json"
      - "./tsconfig.cjs.json:/app/tsconfig.cjs.json"
      - "./tsconfig.esm.json:/app/tsconfig.esm.json"
      - "./.eslintrc.json:/app/.eslintrc.json"
      - "./.eslintignore:/app/.eslintignore"
      - "./jest.config.js:/app/jest.config.js"
    ports:
      - "10000:10000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://node:10000"]
      interval: 60s
      timeout: 60s
      retries: 10
      start_period: 60s
  node_ci:
    build: "."
    image: sv-mosaic:local
    volumes:
      - "~/.ssh:/app/.ssh"
    environment:
      CIRCLE_BRANCH: ${CIRCLE_BRANCH}
      CIRCLE_SHA1: ${CIRCLE_SHA1}
      NPM_TOKEN: ${NPM_TOKEN}
      GITHUB_KEY: ${GITHUB_KEY}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://node_ci:10000"]
      interval: 60s
      timeout: 60s
      retries: 10
      start_period: 60s
  automation_testing:
    build: "./automation_testing"
    image: sv-mosaic:automation_testing
    volumes:
     - "./automation_testing/package.json:/app/package.json"
     - "./automation_testing/utils:/app/utils"
     - "./automation_testing/tests:/app/tests"
     - "./automation_testing/pages:/app/pages"
     - "./automation_testing/sv-mosaic.config.ts:/app/sv-mosaic.config.ts"
    ports:
      - "20000:20000"
    depends_on:
      node:
        condition: service_healthy
  automation_testing_ci:
    build: "./automation_testing"
    image: sv-mosaic:automation_testing
    environment:
      ENV: ${ENV}
    depends_on:
      node_ci:
        condition: service_healthy
